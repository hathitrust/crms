#!/usr/bin/perl

my ($DLXSROOT, $DLPS_DEV);
BEGIN { $DLXSROOT = $ENV{'DLXSROOT'}; $DLPS_DEV = $ENV{'DLPS_DEV'}; }

use strict;
use CGI;
use CRMS;
use Template;
use POSIX;

my $ru = $ENV{'REMOTE_USER'};
my $cgi  = new CGI;
my $sys =  $cgi->param('sys');
$sys = 'crms' unless $sys;
my $crms = CRMS->new(
        logFile      =>   "$DLXSROOT/prep/c/crms/log_review.txt",
        sys          =>   $sys,
        verbose      =>   0,
        root         =>   $DLXSROOT,
        dev          =>   $DLPS_DEV,
        user         =>   $ru,
        );
my $alias = $crms->GetAliasUserName($ru);

if ($cgi->param('p') eq 'Logout')
{
  # Remove all locks for this user.
  # If we're aliased, we don't log out, we just drop the alias.
  if ($alias && $alias ne $ru)
  {
    $crms->UnlockAllItemsForUser($alias);
    $cgi->param('changeuser', 1);
    $cgi->param('newuser', $ru);
  }
  else
  {
    $crms->UnlockAllItemsForUser($ru);
    # change 'central' to the url of your weblogin server.
    my $central = "https://weblogin.umich.edu/cgi-bin/logout";
    my $query_string = "";
    # expire and nullify service cookie
    print( "Set-Cookie: $ENV{ COSIGN_SERVICE }=null; path=/; expires=Wednesday, 27-Jan-77 00:00:00 GMT; secure\n" );
    if ( $ENV{ QUERY_STRING } =~ m|^(https?://.*)$| )
    {
      $query_string = "?$1";
    }
    # perform any local cleanup here
    # redirect to central weblogin server
    print("Location: $central$query_string\n\n");
    exit(0);
  }
}

if ($cgi->param('changeuser') == 1)  
{
  $alias = $cgi->param('newuser');
  if ($crms->GetUserName($alias))
  {
    if ($alias eq $ru)
    {
      $crms->ChangeAliasUserName($ru, '');
    }
    else
    {
      $crms->ChangeAliasUserName($ru, $alias);
    }
  }
  $cgi->delete_all();
}
my $user = ($alias)? $alias:$ru;
if ($user ne $ru)
{
  $crms = CRMS->new(
            logFile => $DLXSROOT . '/prep/c/crms/log_review.txt',
            sys     => $sys,
            verbose => 0,
            root    => $DLXSROOT,
            dev     => $DLPS_DEV,
            user    => $user,
            );
}

## make sure user known
if (!$crms->GetUserName($user))
{
  print $cgi->header(-status => '403 Forbidden') .
        "<h2>Forbidden</h2> (unknown user '$user')";
  exit;
}

if ($cgi->param('p') eq 'confirmReview')  
{
  my $editing = $cgi->param('editing');
  my $id = $cgi->param('barcode');
  if ($cgi->param('submit') eq 'Cancel')
  {
    $crms->UnlockItem($id, $user);
    $cgi->delete_all();
    if ($editing)
    {
      print "Content-type: text/html\n\n";
      print '<script type="text/javascript" language="JavaScript">window.close();</script>';
    }
  }
  else
  {
    #Remove all locks for this user.
    my $EncRights = $cgi->param('rights');
    my $note      = $cgi->param('note');
    my $category  = $cgi->param('category');
    my $renNum    = $cgi->param('renNum');
    my $renDate   = $cgi->param('renDate');
    my $hold      = $cgi->param('hold');
    my $swiss     = $cgi->param('swiss');
    my $pre       = $cgi->param('prepopulated');
    my ($rights, $reason);
    my $err = 'You must select a rights/reason combination.' unless $EncRights;
    if (!$err)
    {
      ($rights, $reason) = $crms->GetAttrReasonFromCode($EncRights);
      $err = $crms->HasItemBeenReviewedByTwoReviewers($id, $user);
      $err = $crms->ValidateSubmission($id, $user, $rights, $reason, $note, $category, $renNum, $renDate) unless $err;
      my $stat = $crms->GetSystemStatus();
      # Actually, this never gets displayed, but that's OK
      my $status = $stat->[1];
      $err = "The CRMS is not currently accepting reviews (status '$status'). Please Cancel." if $stat->[1] ne 'normal';
    }
    if (!$err)
    {
      #Process the submission, and go on to the next item
      my $expert;
      if ( $crms->IsUserExpert( $user ) ) { $expert = 2; }
      $crms->SubmitReview($id, $user, $rights, $reason, $note, $renNum, $expert, $renDate, $category, $swiss, $hold, $pre);
      my $ref = $crms->GetErrors();
      $err = $ref->[0] if $ref && $ref->[0];
    }
    if ($err)
    {
      #clear the cgi
      $cgi->delete_all();
      $cgi->param('p', 'review');
      $cgi->param('errorMsg', $err);
      $cgi->param('barcode',  $id);
      $cgi->param('rights',   $EncRights);
      $cgi->param('reason',   $reason);
      $cgi->param('note',     $note);
      $cgi->param('category', $category);
      $cgi->param('renNum',   $renNum);
      $cgi->param('renDate',  $renDate);
      $cgi->param('editing',  $editing);
      $cgi->param('hold',     $hold);
      $cgi->param('swiss',    $swiss);
      $crms->ClearErrors();
    }
    else
    {
      $cgi->delete_all();
      if ($editing)
      {
        print "Content-type: text/html\n\n";
        print '<script type="text/javascript" language="JavaScript">window.close();</script>';
      }
      else
      {
        $cgi->param('p', 'review' );
      }
    }
  }
}
elsif ($cgi->param('p') eq 'confirmCorrection')  
{
  my $editing = $cgi->param('editing');
  my $id = $cgi->param('barcode');
  if ($cgi->param('submit') eq 'Cancel')
  {
    $crms->UnlockItem($id, $user, 1);
    $cgi->delete_all();
    if ($editing)
    {
      print "Content-type: text/html\n\n";
      print '<script type="text/javascript" language="JavaScript">window.close();</script>';
    }
  }
  else
  {
    my $note    = $cgi->param('note');
    my $fixed   = $cgi->param('fixed');
    my $inScope = $cgi->param('inScope');
    
    my $stat = $crms->GetSystemStatus();
    my $status = $stat->[1];
    my $err;
    $err = "The CRMS is not currently accepting reviews (status '$status'). Please Cancel." if $stat->[1] ne 'normal';
    if (!defined $err)
    {
      #Process the submission, and go on to the next item
      $status = ($fixed)? (($inScope)? 'added':'fixed'):'unfixed';
      my $status = $crms->AddItemToQueueOrSetItemActive($id, 0, 1, 'correction') if $status eq 'added';
      my $ref = $crms->GetErrors();
      $err = $ref->[0] if $ref && $ref->[0];
      if (!$err)
      {
        $err = substr($status, 1) if (substr($status, 0, 1) == 1);
      }
      if (!$err)
      {
        my $sql = 'UPDATE corrections SET status=?,user=?,note=?,time=CURRENT_TIMESTAMP WHERE id=?';
        $crms->PrepareSubmitSql($sql, $status, $user, $note, $id);
      }
    }
    $cgi->delete_all();
    if ($err)
    {
      $cgi->param('p',        'corrections');
      $cgi->param('errorMsg', $err);
      $cgi->param('barcode',  $id);
      $cgi->param('note',     $note);
      $cgi->param('fixed',    $fixed);
      $cgi->param('editing',  $editing);
      $crms->ClearErrors();
    }
    else
    {
      $crms->UnlockItem($id, $user, 1);
      if ($editing)
      {
        print "Content-type: text/html\n\n";
        print '<script type="text/javascript" language="JavaScript">window.close();</script>';
      }
      else
      {
        $cgi->param('p', 'corrections' );
      }
    }
  }
}

$cgi->param('sys', $sys) if $sys and $sys ne 'crms';
if ( $cgi->param('download') )  
{
  my $order            = $cgi->param('order');
  my $dir              = $cgi->param('dir');
  my $search1          = $cgi->param('search1');
  my $search1value     = $cgi->param('search1value');
  my $op1              = $cgi->param('op1');
  my $search2          = $cgi->param('search2');
  my $search2value     = $cgi->param('search2value');
  my $op2              = $cgi->param('op2');
  my $search3          = $cgi->param('search3');
  my $search3value     = $cgi->param('search3value');
  my $startDate        = $cgi->param('startDate');
  my $endDate          = $cgi->param('endDate');
  my $stype            = $cgi->param('stype');
  my $page             = $cgi->param('p');
  my $q                = $cgi->param('q');
  my $success = 1;

  if ($page eq 'retrieve')
  {
    $crms->DownloadVolumeIDs($q)
  }
  elsif ($page eq 'queue')
  {
    $success = $crms->SearchAndDownloadQueue($order, $dir, $search1, $search1value, $op1,
                                             $search2, $search2value, $startDate, $endDate);
  }
  elsif ($page eq 'determinationStats')
  {
    my $monthly = $cgi->param('monthly');
    my $priority = $cgi->param('priority');
    my $pre = $cgi->param('pre');
    $success = $crms->SearchAndDownloadDeterminationStats($startDate, $endDate, $monthly, $priority, $pre);
  }
  elsif ($page =~ m/userrate/i)
  {
    my $page        = $cgi->param('p');
    my $user        = $cgi->param('user');
    my $cumulative  = $cgi->param('cumulative');
    my $year        = $cgi->param('year');
    my $inval       = $cgi->param('inval');
    my $nononexpert = $cgi->param('nne');
    
    $success = $crms->DownloadUserStats($page, $user, $cumulative, $year, $inval, $nononexpert);
  }
  elsif ($page eq 'exportData')
  {
    $success = $crms->SearchAndDownloadExportData($order, $dir, $search1, $search1value, $op1,
                                                  $search2, $search2value, $startDate, $endDate);
  }
  else
  {
    $success = $crms->SearchAndDownload($page, $order, $dir, $search1, $search1value, $op1,
                                        $search2, $search2value, $op2, $search3, $search3value,
                                        $startDate, $endDate, $stype);
  }
  if ($success)
  {
    exit;
  }
}

## config options for TT
my $config = 
{
    INCLUDE_PATH => '.',
    INTERPOLATE  => 1,     ## expand "$var" in plain text
    POST_CHOMP   => 1,     ## cleanup whitespace
    EVAL_PERL    => 1,     ## evaluate Perl code blocks
    ENCODING     => 'UTF-8'
};

my $tt   = Template->new($config);
my $vars = {
    title     => $crms->System(),
    crms      => $crms,
    cgi       => $cgi,
    user      => $user,
    yesterday => POSIX::strftime("%Y-%m-%d %H:%M:%S", localtime(time-86400))
};

## the template page (tt) is called based on the CGI 'p' param (ex editReviews -> editReviews.tt)
## the default is home.tt in case a tt is not found
my $page  = $cgi->param('p');
my $input = $page . ".tt";
$input = 'home.tt' unless -f $input;

print $cgi->header(-charset => 'utf-8', 'cache-control' => 'private');
$tt->process($input, $vars) || die $tt->error();
if ($cgi->param('debug'))
{
  print '<br/><br/>';
  printf 'Host: <b>%s</b><br/>', `hostname`;
  eval {
    foreach my $k (keys %ENV)
    {
      printf "$k: %s<br/>\n", $ENV{$k};
    }
  }
}

