[% INCLUDE header.tt %]

<script type="text/Javascript">
<!--
function CheckAll(box,formid)
{
	var aa=document.getElementById(formid);
	for (var i=0; i < aa.elements.length; i++)
	{
	  aa.elements[i].checked = box.checked;
	}
}
-->
</script>

[% n = crms.CountUserHolds(user) %]
[% IF n %]<h4>You have $n [% crms.Pluralize('volumes', n) %] on hold.</h4><br/>[% END %]

[% IF cgi.param('unlockSel') %]
<br/>
  [% FOREACH param IN cgi.param %]
    [% matches = param.match('(vol_)(.+)') %]
    [% IF matches.0 == 'vol_' %]
      [% ok = crms.UnlockItemEvenIfNotLocked(matches.1) %]
      [% IF ok %]
        <span>Unlocked [% matches.1 %]</span><br/>
      [% ELSE %]
        <span style='color:red;'>Could not unlock [% matches.1 %]</span><br/>
      [% END %]
    [% END %]
  [% END %]
[% ELSIF cgi.param('unlock') %]
  [% ok = crms.UnlockItemEvenIfNotLocked(cgi.param('unlock')) %]
  [% IF ok %]
    <span>Unlocked [% cgi.param('unlock') %]</span><br/>
  [% ELSE %]
    <span style='color:red;'>Could not unlock [% cgi.param('unlock') %]</span><br/>
  [% END %]
[% END %]

<table class="mainnav">
[% menus = crms.Menus() %]
[% i = 0 %]
[% of = menus.size() %]
[% FOREACH menu IN menus %]
  [% id = menu.0 %]
  [% IF i % 2 == 0 %]
    [% class1 = (menus.$i.2)? 'class="' _ menus.$i.2 _ '"':'' %]
    [% class2 = 0 %]
    [% j = i+1 %]
    [% IF j < of %]
      [% class2 = (menus.$j.2)? 'class="' _ menus.$j.2 _ '"':'' %]
      <tr><th><span $class1>[% menus.$i.1 %]</span></th><th><span $class2>[% menus.$j.1 %]</span></th></tr>
    [% ELSE %]
      <tr><th colspan='2'><span $class1>[% menus.$i.1 %]</span></th></tr>
    [% END %]
  [% END %]
  [% colspan = '' %]
  [% IF i % 2 == 0 %]
    [% IF j >= of %][% colspan = 'colspan="2"' %]<tr>[% END %]
  [% END %]
    <td $colspan>
    [% items = crms.MenuItems(id) %]
    [% FOREACH item IN items %]
      [% target = (item.4)? ' target="' _ item.4 _ '"':'' %]
      [% url = item.1 %]
      <a href="[% url %]"[% target %]>[% item.0.replace('\s', '&nbsp;') %]</a><br/>
    [% END %]
    </td>
    [% IF i % 2 != 0 %]</tr>[% END %]
  [% i = i + 1 %]
[% END %]
</table>


[% locked = crms.GetLockedItems(user) %]
[% IF locked.size %]
  [% sysStatus = crms.GetSystemStatus().1 %]
  <br/><br/><form action="crms" id="checks">
  [% crms.HiddenSys() %]
  <input type="checkbox" onclick="CheckAll(this,'checks');"/> Select All&nbsp;&nbsp;&nbsp;&nbsp;
  [% IF sysStatus == 'normal' %]
    <input type="submit" name="unlockSel" value="Unlock Selected Volumes"/>
  [% END %]
  <br/><br/>
  <table class="exportStats" style="width:55%">
  <tr><th colspan="6" style="text-align:center;"><span class="major">Your&nbsp;Locked&nbsp;Items</span></th></tr>
  <tr><th>ID</th><th>Title</th><th>Since</th><th>Select</th><th>Unlock</th></tr>
  [% sys = cgi.param('sys') %]
  [% FOREACH item IN locked.keys %]
    <tr>
      <td>[% item %]</td>
      <td>[% crms.GetTitle( item ) %]</td>
      [% when = crms.ItemLockedSince(locked.${item}.id, locked.${item}.locked) %]
      [% when = crms.FormatTime(when, 1) %]
      <td style="text-align:center">[% when.replace('\s', '&nbsp;') %]</td>
      <td style="text-align:center"><input type="checkbox" name="vol_[% item %]"/></td>
      <td style="text-align:center">
        [% IF sysStatus == 'normal' %]<a href="crms?unlock=[% item %];sys=[% sys %]">do it</a>[% END %]
      </td>
    </tr>
  [% END %]
</table>
</form>
<br/>
[% END %]

[% INCLUDE footer.tt %]
